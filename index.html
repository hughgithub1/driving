<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Colchester Driving Test Routes</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg-primary: #0a0e17; --bg-secondary: #111827; --bg-card: #1a2235;
    --bg-card-hover: #1f2a40; --border: #2a3654; --text-primary: #e8ecf4;
    --text-secondary: #8896b0; --text-muted: #5a6a85; --accent: #3b82f6;
    --accent-glow: rgba(59,130,246,0.25); --success: #10b981; --purple: #8b5cf6;
  }
  body { font-family:'DM Sans',sans-serif; background:var(--bg-primary); color:var(--text-primary); height:100vh; overflow:hidden; display:flex; }
  .sidebar { width:380px; min-width:380px; height:100vh; background:var(--bg-secondary); border-right:1px solid var(--border); display:flex; flex-direction:column; z-index:1000; transition:transform .3s ease; }
  .sidebar-header { padding:20px 24px; border-bottom:1px solid var(--border); background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(139,92,246,.08)); }
  .sidebar-header h1 { font-size:18px; font-weight:700; letter-spacing:-.02em; display:flex; align-items:center; gap:10px; }
  .sidebar-header h1 .icon { width:32px; height:32px; background:var(--accent); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:16px; }
  .sidebar-header p { color:var(--text-secondary); font-size:13px; margin-top:6px; line-height:1.4; }
  .test-centre-badge { display:inline-flex; align-items:center; gap:6px; margin-top:10px; padding:5px 10px; background:rgba(16,185,129,.1); border:1px solid rgba(16,185,129,.2); border-radius:6px; font-size:11px; color:var(--success); font-weight:600; text-transform:uppercase; letter-spacing:.05em; }
  .controls { padding:16px 24px; border-bottom:1px solid var(--border); display:flex; gap:8px; flex-wrap:wrap; }
  .map-toggle { display:flex; background:var(--bg-card); border-radius:8px; border:1px solid var(--border); overflow:hidden; flex:1; }
  .map-toggle button { flex:1; padding:8px 12px; background:transparent; border:none; color:var(--text-secondary); font-family:inherit; font-size:12px; font-weight:600; cursor:pointer; transition:all .2s; }
  .map-toggle button.active { background:var(--accent); color:white; }
  .btn-show-all { padding:8px 14px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:var(--text-secondary); font-family:inherit; font-size:12px; font-weight:600; cursor:pointer; transition:all .2s; white-space:nowrap; }
  .btn-show-all:hover { background:var(--bg-card-hover); color:var(--text-primary); }
  .btn-show-all.active { background:var(--purple); color:white; border-color:var(--purple); }
  .route-list { flex:1; overflow-y:auto; padding:12px; }
  .route-list::-webkit-scrollbar { width:6px; }
  .route-list::-webkit-scrollbar-track { background:transparent; }
  .route-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
  .route-card { padding:14px 16px; background:var(--bg-card); border:1px solid var(--border); border-radius:10px; margin-bottom:8px; cursor:pointer; transition:all .2s ease; position:relative; overflow:hidden; }
  .route-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:var(--route-color,var(--accent)); opacity:0; transition:opacity .2s; }
  .route-card:hover { background:var(--bg-card-hover); border-color:var(--route-color,var(--accent)); }
  .route-card:hover::before,.route-card.active::before { opacity:1; }
  .route-card.active { background:var(--bg-card-hover); border-color:var(--route-color,var(--accent)); box-shadow:0 0 20px var(--accent-glow); }
  .route-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
  .route-number { font-family:'JetBrains Mono',monospace; font-size:13px; font-weight:600; color:var(--route-color,var(--accent)); }
  .route-badge { font-size:10px; padding:2px 8px; border-radius:4px; font-weight:600; text-transform:uppercase; letter-spacing:.05em; }
  .route-badge.urban { background:rgba(59,130,246,.15); color:#60a5fa; }
  .route-badge.rural { background:rgba(16,185,129,.15); color:#34d399; }
  .route-badge.mixed { background:rgba(245,158,11,.15); color:#fbbf24; }
  .route-badge.dual { background:rgba(239,68,68,.15); color:#f87171; }
  .route-name { font-size:13px; font-weight:500; margin-bottom:4px; }
  .route-streets { font-size:11px; color:var(--text-muted); line-height:1.4; }
  .route-meta { display:flex; gap:12px; margin-top:8px; font-size:11px; color:var(--text-secondary); }
  .route-meta span { display:flex; align-items:center; gap:4px; }
  .loading-overlay { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:20px 30px; z-index:2000; display:none; align-items:center; gap:12px; box-shadow:0 20px 60px rgba(0,0,0,.5); }
  .loading-overlay.visible { display:flex; }
  .spinner { width:20px; height:20px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .loading-text { font-size:13px; color:var(--text-secondary); }
  .map-container { flex:1; position:relative; }
  #map { width:100%; height:100%; }
  .directions-panel { position:absolute; bottom:24px; left:24px; right:24px; max-height:200px; background:rgba(17,24,39,.95); backdrop-filter:blur(16px); border:1px solid var(--border); border-radius:12px; padding:16px; overflow-y:auto; z-index:1000; display:none; }
  .directions-panel.visible { display:block; }
  .directions-panel::-webkit-scrollbar { width:4px; }
  .directions-panel::-webkit-scrollbar-track { background:transparent; }
  .directions-panel::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
  .directions-title { font-size:14px; font-weight:700; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; }
  .directions-close { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:18px; padding:0 4px; }
  .direction-step { display:flex; align-items:flex-start; gap:10px; padding:6px 0; font-size:12px; color:var(--text-secondary); border-bottom:1px solid rgba(42,54,84,.5); }
  .direction-step:last-child { border-bottom:none; }
  .step-num { font-family:'JetBrains Mono',monospace; font-size:10px; font-weight:600; color:var(--accent); min-width:20px; height:20px; display:flex; align-items:center; justify-content:center; background:rgba(59,130,246,.1); border-radius:4px; flex-shrink:0; }
  .step-road { font-weight:600; color:var(--text-primary); }
  .step-direction { color:var(--text-muted); }
  .mobile-toggle { display:none; position:absolute; top:16px; left:16px; z-index:1001; width:40px; height:40px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; align-items:center; justify-content:center; cursor:pointer; color:var(--text-primary); font-size:20px; }
  .leaflet-control-zoom { border:1px solid var(--border)!important; border-radius:8px!important; overflow:hidden; }
  .leaflet-control-zoom a { background:var(--bg-card)!important; color:var(--text-primary)!important; border-color:var(--border)!important; width:34px!important; height:34px!important; line-height:34px!important; font-size:16px!important; }
  .leaflet-control-zoom a:hover { background:var(--bg-card-hover)!important; }
  .leaflet-popup-content-wrapper { background:var(--bg-card)!important; border:1px solid var(--border)!important; border-radius:8px!important; color:var(--text-primary)!important; font-family:'DM Sans',sans-serif!important; box-shadow:0 8px 30px rgba(0,0,0,.4)!important; }
  .leaflet-popup-tip { background:var(--bg-card)!important; border:1px solid var(--border)!important; }
  .leaflet-popup-close-button { color:var(--text-muted)!important; }
  .status-banner { position:absolute; top:16px; right:16px; z-index:2001; padding:10px 14px; border-radius:8px; border:1px solid var(--border); background:rgba(17,24,39,.92); color:var(--text-primary); font-size:12px; display:none; max-width:320px; }
  .status-banner.visible { display:block; }
  @media(max-width:768px) {
    .sidebar { position:absolute; top:0; left:0; transform:translateX(-100%); width:320px; min-width:unset; z-index:1100; }
    .sidebar.open { transform:translateX(0); }
    .mobile-toggle { display:flex; }
  }
</style>
</head>
<body>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h1><span class="icon">&#x1F697;</span> Colchester Test Routes</h1>
    <p>15 practical driving test routes from the Colchester DVSA Test Centre, Grange Way CO2 8HF</p>
    <div class="test-centre-badge">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
      DVSA Test Centre - Grange Way
    </div>
  </div>
  <div class="controls">
    <div class="map-toggle" id="mapToggle">
      <button class="active" data-layer="satellite">Satellite</button>
      <button data-layer="street">Street</button>
      <button data-layer="hybrid">Hybrid</button>
    </div>
    <button class="btn-show-all" id="btnShowAll">Show All</button>
  </div>
  <div class="route-list" id="routeList"></div>
</div>
<div class="map-container">
  <button class="mobile-toggle" id="mobileToggle">&#9776;</button>
  <div id="map"></div>
  <div class="status-banner" id="statusBanner"></div>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <span class="loading-text" id="loadingText">Calculating route...</span>
  </div>
  <div class="directions-panel" id="directionsPanel">
    <div class="directions-title">
      <span id="dirTitle">Route Directions</span>
      <button class="directions-close" id="dirClose">&#x2715;</button>
    </div>
    <div id="dirSteps"></div>
  </div>
</div>
<script>
var TEST_CENTRE=[51.87835,0.91755];
var ROUTE_COLORS=['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#84cc16','#06b6d4','#e11d48','#a855f7','#22c55e','#eab308'];
var ROUTES=[
{id:1,name:"South Loop via Maldon Rd & Layer Rd",type:"urban",typeLabel:"Urban",streets:"Magdalen St > Southway > Maldon Rd > Salisbury Ave > Butt Rd > Layer Rd > Berechurch > Mersea Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","Mini r/about right onto Old Heath Rd"],["Old Heath Rd","Left onto Magdalen St"],["Magdalen St","R/about ahead onto Southway"],["Southway","R/about left onto Maldon Rd"],["Maldon Rd","4th left onto Salisbury Ave"],["Salisbury Ave","EOR right onto Butt Rd"],["Butt Rd","Mini r/about left onto Layer Rd"],["Layer Rd","5th right onto Bodicea Way"],["Bodicea Way","EOR right onto Layer Rd"],["Layer Rd","Double mini r/about ahead, left onto Berechurch Hall Rd"],["Berechurch Hall Rd","3rd left onto Berechurch Rd"],["Berechurch Rd","5th right onto Meyrick Crescent"],["Meyrick Crescent","EOR right onto Mersea Rd"],["Mersea Rd","2nd left onto Bourne Rd"],["Bourne Rd","T/L left, crossroads right onto Old Heath Rd"],["Old Heath Rd","Mini r/about left onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.882,0.9065],[51.8845,0.901],[51.8861,0.897],[51.8876,0.891],[51.8883,0.8865],[51.8855,0.884],[51.8818,0.887],[51.8782,0.89],[51.8758,0.892],[51.8735,0.8945],[51.8707,0.9005],[51.868,0.903],[51.87,0.909],[51.872,0.9105],[51.8745,0.907],[51.8775,0.905],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:2,name:"West Loop via Shrub End & Norman Way",type:"mixed",typeLabel:"Mixed",streets:"Magdalen St > Mersea Rd > Circular Rd > Shrub End Rd > Norman Way > Walnut Tree Way > Layer Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","Mini r/about right onto Old Heath Rd"],["Old Heath Rd","Left onto Magdalen St"],["Magdalen St","R/about left onto Mersea Rd"],["Mersea Rd","3rd right onto Pownall Crescent"],["Pownall Crescent","Crossroads ahead onto Circular Rd South"],["Circular Rd South","Right onto Circular Rd West"],["Circular Rd West","EOR left onto Butt Rd"],["Butt Rd","Mini r/about ahead onto Drury Rd"],["Drury Rd / Shrub End Rd","T/L left, crossroads right onto Norman Way"],["Norman Way","Left onto The Commons"],["The Commons","Left onto Winston Ave"],["Winston Ave","EOR right onto Shrub End Rd"],["Shrub End Rd","Left onto Walnut Tree Way"],["Iceni Way","3rd right onto John Kent Ave"],["John Kent Ave","EOR right onto Layer Rd"],["Layer Rd","Double mini r/about ahead, left onto Berechurch Hall Rd"],["Berechurch Hall Rd","EOR mini r/about left onto Mersea Rd"],["Mersea Rd","Mini r/about left onto Abbots Rd"],["Abbots Rd","EOR mini r/about right onto Old Heath Rd"],["Old Heath Rd","Mini r/about right onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.882,0.9065],[51.8845,0.901],[51.8861,0.897],[51.8861,0.8942],[51.879,0.8955],[51.8772,0.893],[51.8758,0.8895],[51.8802,0.887],[51.8825,0.8825],[51.8845,0.8795],[51.8865,0.876],[51.8855,0.8735],[51.881,0.8755],[51.8775,0.878],[51.874,0.8805],[51.872,0.885],[51.8705,0.891],[51.868,0.903],[51.871,0.907],[51.876,0.912],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:3,name:"West via Creffield Rd & Queens Rd",type:"urban",typeLabel:"Urban",streets:"Southway > Maldon Rd > Creffield Rd > Cambridge Rd > Queens Rd > Victoria Rd > Layer Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","Mini r/about right onto Old Heath Rd"],["Old Heath Rd","EOR left onto Magdalen St"],["Magdalen St","R/about ahead onto Southway"],["Southway","R/about left onto Maldon Rd"],["Maldon Rd","Right onto Creffield Rd"],["Creffield Rd","Left, crossroads ahead, EOR left onto Cambridge Rd"],["Cambridge Rd","Right onto Queens Rd"],["Queens Rd","Left onto Victoria Rd"],["Victoria Rd","Right onto Queens Rd"],["Queens Rd","EOR right onto Cambridge Rd"],["Cambridge Rd","EOR right onto Maldon Rd / Shrub End Rd"],["Shrub End Rd","T/L left onto Bodicea Way"],["Bodicea Way","EOR right onto Layer Rd"],["Layer Rd","Mini r/about ahead, left onto Berechurch Hall Rd"],["Berechurch Hall Rd","EOR mini r/about left onto Mersea Rd"],["Mersea Rd","Mini r/about right onto Abbotts Rd"],["Abbotts Rd","EOR mini r/about left onto Old Heath Rd"],["Old Heath Rd","Mini r/about right onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.882,0.9065],[51.8845,0.901],[51.8861,0.897],[51.8876,0.891],[51.8883,0.8865],[51.89,0.883],[51.8915,0.881],[51.8905,0.878],[51.889,0.876],[51.888,0.878],[51.8905,0.878],[51.8915,0.881],[51.8883,0.8865],[51.885,0.889],[51.878,0.892],[51.8735,0.8945],[51.868,0.903],[51.871,0.907],[51.876,0.912],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:4,name:"West via Lexden & Parsons Heath",type:"mixed",typeLabel:"Mixed",streets:"Southway > Lexden Rd > Church Lane > Parsons Hill > Gainsborough Rd > The Commons > Shrub End Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","Mini r/about right onto Old Heath Rd"],["Old Heath Rd","Left onto Magdalen St"],["Magdalen St","R/about ahead onto Southway"],["Southway","R/about ahead onto Lexden Rd"],["Lexden Rd","9th left onto Church Lane"],["Church Lane","Left onto Parsons Hill"],["Parsons Hill","Left onto Magazine Farm Way"],["Magazine Farm Way","EOR right, right onto Gainsborough Rd"],["Gainsborough Rd","Left onto Van Dyck Rd"],["Van Dyck Rd","EOR left onto The Commons"],["The Commons","Right onto Winston Ave"],["Winston Ave","EOR left onto Shrub End Rd"],["Shrub End Rd","T/L left, crossroads right onto Bodicea Rd"],["Bodicea Rd","EOR right onto Layer Rd"],["Layer Rd","Double mini r/about ahead, left onto Berechurch Hall Rd"],["Berechurch Hall Rd","EOR mini r/about left onto Mersea Rd"],["Mersea Rd","Mini r/about right onto Abbotts Rd"],["Abbotts Rd","EOR mini r/about right onto Old Heath Rd"],["Old Heath Rd","Mini r/about right onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.882,0.9065],[51.8845,0.901],[51.8861,0.897],[51.8876,0.891],[51.889,0.8845],[51.89,0.878],[51.8915,0.8725],[51.8925,0.8685],[51.8915,0.865],[51.89,0.867],[51.888,0.87],[51.886,0.873],[51.884,0.875],[51.878,0.892],[51.8735,0.8945],[51.868,0.903],[51.871,0.907],[51.876,0.912],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:5,name:"South via Abbotts Rd & Fingringhoe Rd",type:"rural",typeLabel:"Rural",streets:"Abbotts Rd > Mersea Rd > Berechurch Rd > Gurdon Rd > Berechurch Hall Rd > Haye Lane > Abberton Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","Mini r/about left onto Old Heath Rd"],["Old Heath Rd","Mini r/about right onto Abbotts Rd"],["Abbotts Rd","Mini r/about right onto Mersea Rd"],["Mersea Rd","2nd left onto Pownall Crescent"],["Pownall Crescent","3rd left onto Berechurch Rd"],["Berechurch Rd","2nd left onto Daniel Cole Rd"],["Daniel Cole Rd","Right onto Gurdon Rd"],["Gurdon Rd","EOR left onto Berechurch Rd"],["Berechurch Rd","Crossroads left onto Berechurch Hall Rd"],["Berechurch Hall Rd","Mini r/about right onto Mersea Rd"],["Mersea Rd","3rd left onto Haye Lane"],["Haye Lane","EOR left onto Abberton Rd"],["Abberton Rd","Left onto Fingringhoe Rd"],["Fingringhoe Rd","Mini r/about ahead, right onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.8775,0.908],[51.876,0.912],[51.8745,0.9085],[51.8725,0.9055],[51.87,0.909],[51.8685,0.9105],[51.867,0.912],[51.866,0.91],[51.867,0.906],[51.868,0.903],[51.869,0.913],[51.8665,0.916],[51.87,0.92],[51.874,0.922],[51.877,0.917],[51.87945,0.9126],[51.87835,0.91755]]},
{id:6,name:"Town Centre via Balkerne Hill & Headgate",type:"urban",typeLabel:"Urban",streets:"Southway > Lexden Rd > Cymbeline Way > Ave of Remembrance > Westway > Balkerne Hill > St Johns St",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","Mini r/about right onto Old Heath Rd"],["Old Heath Rd","EOR left onto Magdalen St"],["Magdalen St","R/about ahead onto Southway"],["Southway","R/about ahead onto Lexden Rd"],["Lexden Rd","5th right onto Lockhart Ave"],["Lockhart Ave","EOR right onto Lexden Rd"],["Lexden Rd","R/about right onto Cymbeline Way"],["Cymbeline Way","R/about right 3rd exit onto Ave of Remembrance"],["Ave of Remembrance","R/about right 3rd exit onto Westway"],["Westway","R/about right onto Balkerne Hill"],["Balkerne Hill","R/about left onto Southway"],["Southway","Left onto Headgate"],["Headgate","T/L right onto St Johns St"],["St Johns St","Right onto Stanwell St"],["Stanwell St","Left onto Southway"],["Southway","R/about ahead onto Magdalen St"],["Magdalen St","Right onto Military Rd / Old Heath Rd"],["Old Heath Rd","Mini r/about left onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.882,0.9065],[51.8845,0.901],[51.8861,0.897],[51.8876,0.891],[51.889,0.8845],[51.89,0.8805],[51.891,0.887],[51.8925,0.89],[51.8915,0.894],[51.8905,0.8955],[51.8895,0.8935],[51.8885,0.892],[51.8875,0.8935],[51.887,0.896],[51.8861,0.897],[51.8845,0.901],[51.882,0.9065],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:7,name:"Lexden Loop via Fitzwalter & Sussex Rd",type:"urban",typeLabel:"Urban",streets:"Balkerne Hill > Westway > Cymbeline Way > Lexden Rd > Fitzwalter Rd > Lockhart Ave > Sussex Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","EOR right onto Old Heath Rd"],["Old Heath Rd","T/L ahead onto Military Rd"],["Military Rd","EOR left onto Magdalen St"],["Magdalen St","R/about ahead onto Southway"],["Southway","R/about right onto Balkerne Hill"],["Balkerne Hill","R/about ahead onto Westway"],["Westway","R/about left onto Cymbeline Way"],["Cymbeline Way","R/about ahead, left onto Lexden Rd"],["Lexden Rd","3rd right onto St Clare Rd"],["St Clare Rd","Left onto Fitzwalter Rd"],["Fitzwalter Rd","EOR right onto Lexden Rd"],["Lexden Rd","2nd left onto Lockhart Ave"],["Lockhart Ave","EOR right onto The Chantry"],["The Chantry","EOR right onto Sussex Rd"],["Sussex Rd","EOR left onto Lexden Rd"],["Lexden Rd","R/about ahead onto Southway"],["Southway","R/about ahead onto Magdalen St"],["Magdalen St","Right onto Military Rd > Old Heath Rd"],["Old Heath Rd","4th left onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.882,0.9065],[51.8845,0.901],[51.8861,0.897],[51.8876,0.891],[51.8895,0.8935],[51.8905,0.8955],[51.8915,0.894],[51.891,0.887],[51.889,0.8825],[51.89,0.879],[51.8885,0.876],[51.889,0.8805],[51.8885,0.8825],[51.888,0.884],[51.889,0.8845],[51.8876,0.891],[51.8861,0.897],[51.8845,0.901],[51.882,0.9065],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:8,name:"South via Barnhall Ave & Mersea Rd",type:"urban",typeLabel:"Urban",streets:"Old Heath Rd > Barnhall Ave > Churchill Way > Normandy Ave > Mersea Rd > Berechurch Rd > Layer Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","EOR right onto Old Heath Rd"],["Old Heath Rd","2nd left onto Barnhall Ave"],["Barnhall Ave","EOR left onto Churchill Way"],["Churchill Way","Left onto Normandy Ave"],["Normandy Ave","EOR right onto Mersea Rd"],["Mersea Rd","2nd left onto Pownall Crescent"],["Pownall Crescent","3rd left onto Berechurch Rd"],["Berechurch Rd","Crossroads ahead onto Bounstead Rd"],["Bounstead Rd","EOR left onto Layer Rd"],["Layer Rd","Crossroads left onto Mersea Rd"],["Mersea Rd","Mini r/about ahead, right onto Abbots Rd"],["Abbots Rd","Mini r/about left onto Old Heath Rd"],["Old Heath Rd","Right onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.882,0.9065],[51.8805,0.9035],[51.879,0.901],[51.8775,0.902],[51.876,0.9],[51.8745,0.902],[51.8725,0.9055],[51.8705,0.9085],[51.869,0.91],[51.8675,0.907],[51.87,0.901],[51.871,0.907],[51.876,0.912],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:9,name:"South-East via Rowhedge & Fingringhoe",type:"rural",typeLabel:"Rural",streets:"Old Heath Rd > Rowhedge Rd > Fingringhoe Rd > Abberton Rd > Mersea Rd > The Willows > Bourne Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","EOR left onto Old Heath Rd"],["Old Heath Rd","Mini r/about ahead, left onto Rowhedge Rd"],["Rowhedge Rd","EOR left onto Fingringhoe Rd"],["Fingringhoe Rd","EOR right onto Abberton Rd"],["Abberton Rd","2nd right onto Fingringhoe Rd"],["Fingringhoe Rd","Crossroads right onto Mersea Rd"],["Mersea Rd","3x mini r/about, 2nd left onto The Willows"],["The Willows","Right, EOR left onto Mersea Rd"],["Mersea Rd","Mini r/about ahead, 3rd right onto Bourne Rd"],["Bourne Rd","T/L right onto Old Heath Rd"],["Old Heath Rd","Mini r/about left onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.8775,0.908],[51.876,0.912],[51.8735,0.9155],[51.87,0.92],[51.867,0.923],[51.865,0.919],[51.867,0.915],[51.87,0.91],[51.8725,0.903],[51.875,0.906],[51.8775,0.905],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:10,name:"South via Queensland Dr & Bounstead Rd",type:"urban",typeLabel:"Urban",streets:"Abbotts Rd > Mersea Rd > Queensland Dr > Adelaide Dr > Berechurch Hall Rd > Bounstead Rd > Layer Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","Mini r/about left onto Old Heath Rd"],["Old Heath Rd","Mini r/about right onto Abbotts Rd"],["Abbotts Rd","Mini r/about left onto Mersea Rd"],["Mersea Rd","Mini r/about left onto Queensland Dr"],["Queensland Dr","Right onto Adelaide Dr"],["Adelaide Dr","EOR left onto Queensland Dr"],["Queensland Dr","Mini r/about left onto Mersea Rd"],["Mersea Rd","Mini r/about right onto Berechurch Hall Rd"],["Berechurch Hall Rd","3rd left onto Bounstead Rd"],["Bounstead Rd","EOR left onto Layer Rd"],["Layer Rd","Left onto Mersea Rd"],["Mersea Rd","3x mini r/about, right onto Abbotts Rd"],["Abbotts Rd","Mini r/about left onto Old Heath Rd"],["Old Heath Rd","Mini r/about right onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.8775,0.908],[51.876,0.912],[51.8745,0.9085],[51.8725,0.9065],[51.8705,0.9045],[51.8695,0.9025],[51.8685,0.9045],[51.8705,0.9045],[51.868,0.903],[51.8675,0.907],[51.871,0.907],[51.8745,0.9085],[51.876,0.912],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:11,name:"South-East via Abberton & Queen Elizabeth Way",type:"rural",typeLabel:"Rural",streets:"Fingringhoe Rd > Abberton Rd > Haye Lane > Mersea Rd > Queen Elizabeth Way > The Willows > Hythe Hill",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","EOR left onto Old Heath Rd / Fingringhoe Rd"],["Fingringhoe Rd","EOR right onto Abberton Rd"],["Abberton Rd","Right onto Haye Lane"],["Haye Lane","EOR right onto Mersea Rd"],["Mersea Rd","R/about ahead, 2nd left onto Queen Elizabeth Way"],["Queen Elizabeth Way","EOR left onto Mersea Rd"],["Mersea Rd","Left onto The Willows"],["The Willows","2nd left onto Silverthorne Close"],["Silverthorne Close","EOR left onto The Willows"],["The Willows","EOR left onto Mersea Rd"],["Mersea Rd","2nd right onto Bourne Rd"],["Bourne Rd","T/L ahead onto Wimpole Rd"],["Wimpole Rd","T/L right onto Hythe Hill"],["Hythe Hill","R/about right onto Maudlyn Rd"],["Maudlyn Rd","Mini r/about right onto Haven Rd"],["Haven Rd","R/about ahead, right onto Whitehall Rd"],["Whitehall Rd","2nd left onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.8775,0.908],[51.874,0.915],[51.87,0.92],[51.867,0.917],[51.869,0.913],[51.871,0.907],[51.8695,0.905],[51.8705,0.903],[51.8715,0.902],[51.8735,0.9055],[51.875,0.906],[51.8775,0.905],[51.881,0.905],[51.883,0.907],[51.8835,0.91],[51.881,0.9115],[51.87945,0.9126],[51.87835,0.91755]]},
{id:12,name:"West via Balkerne Hill & Circular Rd",type:"urban",typeLabel:"Urban",streets:"Southway > Balkerne Hill > Westway > Cymbeline Way > Glen Ave > Lockhart Ave > Salisbury Ave > Circular Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","Mini r/about right onto Old Heath Rd"],["Old Heath Rd","EOR left onto Magdalen St"],["Magdalen St","R/about ahead onto Southway"],["Southway","R/about right onto Balkerne Hill"],["Balkerne Hill","R/about ahead onto Westway"],["Westway","R/about left onto Cymbeline Way"],["Cymbeline Way","2nd left onto Glen Ave"],["Glen Ave","EOR left onto Lexden Rd"],["Lexden Rd","2nd left onto Lockhart Ave"],["Lockhart Ave","EOR left onto Lexden Rd"],["Lexden Rd","R/about right onto Maldon Rd"],["Maldon Rd","4th left onto Salisbury Ave"],["Salisbury Ave","EOR right onto Butt Rd"],["Butt Rd","Left onto Circular Rd West"],["Circular Rd West","Left onto Circular Rd North"],["Circular Rd North","Right onto Circular Rd East"],["Circular Rd East","EOR left onto Berechurch Rd"],["Berechurch Rd","Right onto Meyrick Crescent"],["Meyrick Crescent","EOR right onto Mersea Rd"],["Mersea Rd","2nd left onto Bourne Rd"],["Bourne Rd","T/L crossroads right onto Old Heath Rd"],["Old Heath Rd","Mini r/about left onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.882,0.9065],[51.8845,0.901],[51.8861,0.897],[51.8895,0.8935],[51.8905,0.8955],[51.8915,0.894],[51.891,0.887],[51.8905,0.8835],[51.8895,0.8815],[51.889,0.8825],[51.889,0.8845],[51.8883,0.8865],[51.8855,0.884],[51.8818,0.887],[51.8795,0.888],[51.878,0.891],[51.872,0.9105],[51.8745,0.907],[51.8775,0.905],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:13,name:"West via Norman Way & Walnut Tree Way",type:"mixed",typeLabel:"Mixed",streets:"Southway > Maldon Rd > Norman Way > The Commons > Shrub End Rd > Walnut Tree Way > Rayner Rd > Layer Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","Mini r/about right onto Old Heath Rd"],["Old Heath Rd","Left onto Magdalen St"],["Magdalen St","R/about ahead onto Southway"],["Southway","R/about left onto Maldon Rd"],["Maldon Rd","T/L crossroads right onto Norman Way"],["Norman Way","Left onto The Commons"],["The Commons","Left onto Winston Ave"],["Winston Ave","EOR right onto Shrub End Rd"],["Shrub End Rd","Left onto Walnut Tree Way"],["Walnut Tree Way","Left onto Rayner Rd"],["Rayner Rd","Left onto Walnut Tree Way / Iceni Way"],["Iceni Way","3rd right onto John Kent Ave"],["John Kent Ave","EOR right onto Layer Rd"],["Layer Rd","Double mini r/about ahead, left onto Berechurch Hall Rd"],["Berechurch Hall Rd","EOR left onto Mersea Rd"],["Mersea Rd","Mini r/about right onto Abbotts Rd"],["Abbotts Rd","EOR left onto Old Heath Rd"],["Old Heath Rd","Mini r/about right onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.882,0.9065],[51.8845,0.901],[51.8861,0.897],[51.8876,0.891],[51.8883,0.8865],[51.8865,0.882],[51.8855,0.8795],[51.8835,0.877],[51.8815,0.875],[51.881,0.876],[51.8785,0.878],[51.876,0.88],[51.8735,0.883],[51.8705,0.891],[51.868,0.903],[51.871,0.907],[51.876,0.912],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]},
{id:14,name:"East via Greenstead & Wivenhoe Rd",type:"dual",typeLabel:"Dual C'way",streets:"Haven Rd > Colne Causeway > Greenstead Ring > Avon Way > Magnolia Dr > Bromley Rd > St Andrews Ave",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR right onto Whitehall Rd"],["Whitehall Rd","EOR left onto Haven Rd"],["Haven Rd","R/about right onto Colne Causeway"],["Colne Causeway","R/about ahead onto Eastern Approach"],["Greenstead Ring","R/about ahead onto Avon Way"],["Avon Way","6th left onto Magnolia Drive"],["Magnolia Drive","Left onto Hamlet Drive"],["Hamlet Drive","EOR left onto Avon Way"],["Avon Way","2nd left onto Kingfisher Close"],["Kingfisher Close","EOR left onto Longridge"],["Longridge","EOR right onto Bromley Rd"],["Bromley Rd","2nd right onto Tye Rd"],["Tye Rd","EOR left onto Clacton Rd"],["Clacton Rd","2nd right onto School Rd"],["School Rd","Right onto Bird Farm Rd"],["Bird Farm Rd","EOR right onto Brightlingsea Rd"],["Brightlingsea Rd","Right onto Colchester Rd"],["Colchester Rd","EOR left onto St Andrews Ave"],["St Andrews Ave","Greenstead Ring left onto Eastern Approach"],["Eastern Approach","2x r/about ahead onto Colne Causeway"],["Colne Causeway","R/about left onto Haven Rd"],["Haven Rd","Right onto Whitehall Rd"],["Whitehall Rd","3rd left onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.8825,0.911],[51.884,0.914],[51.886,0.918],[51.8885,0.922],[51.891,0.926],[51.8925,0.929],[51.892,0.9315],[51.8905,0.9305],[51.891,0.933],[51.8885,0.9365],[51.887,0.939],[51.8855,0.941],[51.887,0.9435],[51.8895,0.943],[51.8905,0.939],[51.892,0.935],[51.891,0.926],[51.8885,0.922],[51.886,0.918],[51.884,0.914],[51.8825,0.911],[51.87945,0.9126],[51.87835,0.91755]]},
{id:15,name:"South via Barnhall Ave & Queensland Dr",type:"urban",typeLabel:"Urban",streets:"Old Heath Rd > Barnhall Ave > Cavendish Ave > Wimpole Rd > Magdalen St > Mersea Rd > Queensland Dr > Fingringhoe Rd",directions:[["DTC","Left onto Grange Way"],["Grange Way","EOR left onto Whitehall Rd"],["Whitehall Rd","Mini r/about right onto Old Heath Rd"],["Old Heath Rd","2nd left onto Barnhall Ave"],["Barnhall Ave","2nd left onto Cavendish Ave"],["Cavendish Ave","Right onto Barnhall Ave"],["Barnhall Ave","EOR left onto Old Heath Rd"],["Old Heath Rd","T/L right onto Wimpole Rd"],["Wimpole Rd","T/L left onto Magdalen St"],["Magdalen St","R/about left onto Mersea Rd"],["Mersea Rd","Mini r/about left onto Queensland Dr"],["Queensland Dr","Right onto Adelaide Dr"],["Adelaide Dr","EOR left onto Queensland Dr"],["Queensland Dr","Mini r/about left onto Mersea Rd"],["Mersea Rd","Mini r/about ahead, left onto Fingringhoe Rd"],["Fingringhoe Rd","EOR left onto Abberton Rd"],["Abberton Rd","Left onto Fingringhoe Rd / Old Heath Rd"],["Old Heath Rd","Mini r/about ahead, right onto Whitehall Rd"],["Whitehall Rd","Right onto Grange Way > DTC"]],waypoints:[[51.87835,0.91755],[51.87945,0.9126],[51.881,0.9095],[51.882,0.9065],[51.8805,0.9035],[51.879,0.901],[51.878,0.903],[51.8805,0.9035],[51.8815,0.9045],[51.883,0.905],[51.8861,0.897],[51.8745,0.9085],[51.8725,0.9065],[51.8705,0.9045],[51.8695,0.9025],[51.8685,0.9045],[51.8725,0.9065],[51.87,0.92],[51.867,0.917],[51.874,0.915],[51.8775,0.908],[51.881,0.9095],[51.87945,0.9126],[51.87835,0.91755]]}
];

var map, tileLayers, currentLayer;
var activeRouteId=null, routeLayers={}, showingAll=false;

function setStatus(message){
  var el=document.getElementById('statusBanner');
  if(!message){el.classList.remove('visible');el.textContent='';return;}
  el.textContent=message;
  el.classList.add('visible');
}

function setMapLayer(type){
  if(!map)return;
  Object.values(tileLayers).forEach(function(l){if(map.hasLayer(l))map.removeLayer(l);});
  tileLayers[type].addTo(map);
  currentLayer=type;
  document.querySelectorAll('.map-toggle button').forEach(function(b){b.classList.toggle('active',b.getAttribute('data-layer')===type);});
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}
function closeDirections(){document.getElementById('directionsPanel').classList.remove('visible');}
function showLoading(t){document.getElementById('loadingText').textContent=t||'Calculating route...';document.getElementById('loadingOverlay').classList.add('visible');}
function hideLoading(){document.getElementById('loadingOverlay').classList.remove('visible');}

function renderRouteList(){
  var list=document.getElementById('routeList');
  list.innerHTML=ROUTES.map(function(r){
    var c=ROUTE_COLORS[r.id-1];
    return '<div class="route-card" id="card-'+r.id+'" style="--route-color:'+c+'" data-id="'+r.id+'">'+
      '<div class="route-card-header"><span class="route-number">Route '+r.id+'</span><span class="route-badge '+r.type+'">'+r.typeLabel+'</span></div>'+
      '<div class="route-name">'+r.name+'</div><div class="route-streets">'+r.streets+'</div>'+
      '<div class="route-meta"><span>&#x1F4CD; '+r.directions.length+' turns</span><span>&#x1F504; Circular</span></div></div>';
  }).join('');
  list.addEventListener('click',function(e){
    var card=e.target.closest('.route-card');
    if(card)selectRoute(parseInt(card.dataset.id));
  });
}

async function getOSRMRoute(waypoints){
  var coords=waypoints.map(function(w){return w[1]+','+w[0];}).join(';');
  try{
    var r=await fetch('https://router.project-osrm.org/route/v1/driving/'+coords+'?overview=full&geometries=geojson');
    var d=await r.json();
    if(d.code==='Ok'&&d.routes&&d.routes[0])return d.routes[0].geometry.coordinates.map(function(c){return[c[1],c[0]];});
  }catch(e){console.warn('OSRM fail:',e);}
  return waypoints;
}

async function displayRoute(routeId,fitBounds){
  if(fitBounds===undefined)fitBounds=true;
  var route=ROUTES.find(function(r){return r.id===routeId;});
  if(!route||!map)return;
  var color=ROUTE_COLORS[routeId-1];
  if(routeLayers[routeId]){if(fitBounds)map.fitBounds(routeLayers[routeId].bounds,{padding:[60,60]});return;}
  var rc=await getOSRMRoute(route.waypoints);
  var poly=L.polyline(rc,{color:color,weight:5,opacity:0.85,lineJoin:'round',lineCap:'round'}).addTo(map);
  var si=L.divIcon({className:'',html:'<div style="width:28px;height:28px;background:'+color+';border:2px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;box-shadow:0 2px 8px rgba(0,0,0,.3);font-family:JetBrains Mono,monospace;">'+routeId+'</div>',iconSize:[28,28],iconAnchor:[14,14]});
  var mk=L.marker(TEST_CENTRE,{icon:si}).addTo(map);
  mk.bindPopup('<div style="font-family:DM Sans,sans-serif;padding:4px"><div style="font-weight:700;font-size:13px;color:'+color+'">Route '+routeId+'</div><div style="font-size:12px;margin-top:2px">'+route.name+'</div></div>');
  var lg=L.layerGroup([poly,mk]);lg.addTo(map);lg.bounds=poly.getBounds();routeLayers[routeId]=lg;
  if(fitBounds)map.fitBounds(poly.getBounds(),{padding:[60,60]});
}

function removeRoute(id){if(routeLayers[id]){map.removeLayer(routeLayers[id]);delete routeLayers[id];}}

async function selectRoute(routeId){
  if(showingAll)toggleShowAll();
  if(activeRouteId&&activeRouteId!==routeId){removeRoute(activeRouteId);var pc=document.getElementById('card-'+activeRouteId);if(pc)pc.classList.remove('active');}
  if(activeRouteId===routeId){removeRoute(routeId);var c=document.getElementById('card-'+routeId);if(c)c.classList.remove('active');activeRouteId=null;closeDirections();map.setView(TEST_CENTRE,14);return;}
  activeRouteId=routeId;
  document.querySelectorAll('.route-card').forEach(function(c){c.classList.remove('active');});
  var ac=document.getElementById('card-'+routeId);if(ac)ac.classList.add('active');
  showLoading('Calculating route '+routeId+'...');
  await displayRoute(routeId);
  hideLoading();
  showDirections(routeId);
  if(window.innerWidth<=768)document.getElementById('sidebar').classList.remove('open');
}

async function toggleShowAll(){
  var btn=document.getElementById('btnShowAll');
  if(showingAll){ROUTES.forEach(function(r){removeRoute(r.id);});showingAll=false;btn.classList.remove('active');btn.textContent='Show All';activeRouteId=null;document.querySelectorAll('.route-card').forEach(function(c){c.classList.remove('active');});closeDirections();map.setView(TEST_CENTRE,14);return;}
  if(activeRouteId){removeRoute(activeRouteId);var c=document.getElementById('card-'+activeRouteId);if(c)c.classList.remove('active');activeRouteId=null;closeDirections();}
  showingAll=true;btn.classList.add('active');btn.textContent='Clear All';
  showLoading('Loading all 15 routes...');
  var ab=L.latLngBounds([]);
  for(var i=0;i<ROUTES.length;i++){
    showLoading('Loading route '+(i+1)+' of 15...');
    await displayRoute(ROUTES[i].id,false);
    if(routeLayers[ROUTES[i].id]&&routeLayers[ROUTES[i].id].bounds)ab.extend(routeLayers[ROUTES[i].id].bounds);
    if(i<ROUTES.length-1)await new Promise(function(r){setTimeout(r,350);});
  }
  hideLoading();
  if(ab.isValid())map.fitBounds(ab,{padding:[60,60]});
}

function showDirections(routeId){
  var route=ROUTES.find(function(r){return r.id===routeId;});if(!route)return;
  var color=ROUTE_COLORS[routeId-1];
  document.getElementById('dirTitle').innerHTML='<span style="color:'+color+'">Route '+routeId+'</span> &mdash; '+route.name;
  document.getElementById('dirSteps').innerHTML=route.directions.map(function(d,i){
    return '<div class="direction-step"><span class="step-num">'+(i+1)+'</span><div><span class="step-road">'+d[0]+'</span> <span class="step-direction">&mdash; '+d[1]+'</span></div></div>';
  }).join('');
  document.getElementById('directionsPanel').classList.add('visible');
}

function initMap(){
  tileLayers={
    satellite:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri, Maxar',maxZoom:19}),
    street:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OpenStreetMap',maxZoom:19}),
    hybrid:L.layerGroup([L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19}),L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,opacity:0.35})])
  };
  map=L.map('map',{center:TEST_CENTRE,zoom:14,zoomControl:true,layers:[tileLayers.satellite]});
  currentLayer='satellite';
  var tcI=L.divIcon({className:'',html:'<div style="width:40px;height:40px;background:#10b981;border:3px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 2px 12px rgba(16,185,129,.5);">&#x1F3C1;</div>',iconSize:[40,40],iconAnchor:[20,20],popupAnchor:[0,-24]});
  L.marker(TEST_CENTRE,{icon:tcI}).addTo(map).bindPopup('<div style="font-family:DM Sans,sans-serif;padding:4px"><div style="font-weight:700;font-size:14px">DVSA Test Centre</div><div style="font-size:12px;color:#8896b0">Grange Way, Colchester CO2 8HF</div><div style="font-size:11px;color:#5a6a85;margin-top:4px">All routes start and end here</div></div>');
  map.invalidateSize();
  setTimeout(function(){map.invalidateSize();},200);
}

function loadLeafletWithFallback(){
  return new Promise(function(resolve,reject){
    if(typeof L!=='undefined'){resolve();return;}
    var primary=document.createElement('script');
    primary.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    primary.onload=function(){resolve();};
    primary.onerror=function(){
      var secondary=document.createElement('script');
      secondary.src='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';
      secondary.onload=function(){resolve();};
      secondary.onerror=function(){reject(new Error('Failed to load Leaflet from both CDNs.'));};
      document.head.appendChild(secondary);
    };
    document.head.appendChild(primary);
  });
}

function bootstrap(){
  renderRouteList();
  document.getElementById('mapToggle').addEventListener('click',function(e){var b=e.target.closest('button');if(b&&b.dataset.layer)setMapLayer(b.dataset.layer);});
  document.getElementById('btnShowAll').addEventListener('click',function(){toggleShowAll();});
  document.getElementById('mobileToggle').addEventListener('click',function(){toggleSidebar();});
  document.getElementById('dirClose').addEventListener('click',function(){closeDirections();});

  setStatus('Loading map library...');
  loadLeafletWithFallback()
    .then(function(){
      initMap();
      setStatus('');
    })
    .catch(function(err){
      console.error(err);
      setStatus('Map failed to load. Please check internet access and refresh.');
    });
}

bootstrap();
</script>
</body>
</html>
